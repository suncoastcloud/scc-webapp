trigger:
  - main

pool: msi-pool

stages:
  - stage: DeployInfrastructure
    jobs:
      - job: Deploy
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: "scc-sc"
              scriptType: "pscore"
              scriptLocation: "inlineScript"
              inlineScript: |
                $output = az deployment sub create --location 'southcentralus' --template-file main.bicep --query "{ storageAccountName:properties.outputs.storageAccountName.value, storageContainerName:properties.outputs.storageContainerName.value}" --output json
                $deployment = $output | ConvertFrom-Json

                # convert storage details to pipeline variables
                echo "##vso[task.setvariable variable=storageAccountName]$($deployment.storageAccountName)"
                echo "##vso[task.setvariable variable=storageContainerName]$($deployment.storageContainerName)"
                
                # Display the storage account and container names in the console
                Write-Host "Storage Account Name: $($deployment.storageAccountName)"
                Write-Host "Storage Container Name: $($deployment.storageContainerName.Split('/')[-1])"
                Write-Host "Pipeline Workspace: $(Pipeline.Workspace)"

  - stage: UploadFiles
    jobs:
      - job: Upload
        dependsOn: DeployInfrastructure
        steps:
          - task: AzureFileCopy@4
            inputs:
              SourcePath: '$(Pipeline.Workspace)/_scc-webapp'
              azureSubscription: 'scc-sc'
              Destination: 'AzureBlob'
              storage: '$(storageAccountName)'
              ContainerName: '$(storageContainerName)'
              outputStorageUri: 'outputStorageUri'
              outputStorageContainerSasToken: 'outputStorageContainerSasToken'
              sasTokenTimeOutInMinutes: '240'
              CleanTargetBeforeCopy: true
              OverWrite: true
              enableCopyPrerequisites: false
              SkipArtifactsDownload: true
              sasTokenTimeOutInMinutes: 240
              TargetPath: '$web'              